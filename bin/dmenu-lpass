#!/bin/sh

set -euo pipefail

__help="Usage: ${0##*/} [OPTIONS]

Display a dmenu for accounts stored in LastPass. The default LastPass account
to use is specified by the LPASS_EMAIL environment variable.

Options:
  -h, --help               display this help and exit
  -a, --account ACCOUNT    the lpass account
                           (default: \$LPASS_EMAIL)"

unset lpass_email

check_argument() { [ $# -ge 2 ] || { echo "Error: flag $1 requires an argument." && exit 1; } }

while [ ! $# -eq 0 ]; do
  case "$1" in
    -h | --help)
      echo "$__help"
      exit 0
      ;;
    -a | --account)
      check_argument "$@"
      lpass_email=$2
      shift
      ;;
    *)
      break;
      ;;
  esac
  shift
done

[ -z "$*" ] || { echo "Error: unexpected positional arguments: $*." && exit 1; }

lpass_email=${lpass_email:-$LPASS_EMAIL}

dmenu_cmd() {
  rofi -i -fuzzy -dmenu -p "$1"
}

lpass status || lpass login "$lpass_email"
selected_account=$(lpass ls --format '%aN' | dmenu_cmd 'lpass')
[ -z "$selected_account" ] && exit
lpass show --clip --password "$selected_account"
