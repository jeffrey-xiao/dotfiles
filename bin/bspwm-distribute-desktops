#!/bin/sh

monitors=$(xrandr |
  grep '\bconnected\b' |
  sed 's/primary //' |
  cut --fields=1,3 --delimiter=' ' |
  uniq --skip-fields 1 |
  cut --fields=1 --delimiter=' '
)
monitors=$(polybar --list-monitors | cut --delimiter=':' --fields=1)
monitor_count=$(echo "$monitors" | wc -l)
focused_desktop=$(bspc query --desktops --desktop .focused)
initial_desktop_count="$(bspc query --desktops | wc -l)"
desktop_count=10
q=$((desktop_count / monitor_count))
r=$((desktop_count % monitor_count))

total=0
for curr_monitor in $monitors; do
  curr=$q
  if [ $r -gt 0 ]; then
    curr=$((curr + 1))
    r=$((r - 1))
  fi

  if [ "$initial_desktop_count" -ge $desktop_count ]; then
    # Move desktops.
    for i in $(seq $total $((total + curr - 1))); do
      curr_desktop=$(bspc query --desktops --desktop "$i")
      bspc desktop --focus "$curr_desktop"
      bspc desktop "$curr_desktop" --to-monitor "$curr_monitor"
    done
    bspc query --monitor "$curr_monitor" --tree | jq '.desktops[].name' | sort -n | xargs bspc monitor "$curr_monitor" --reorder-desktops
  fi
  # Initialize desktops.
  bspc monitor "$curr_monitor" --reset-desktops $(seq $total $((total + curr - 1)))
  total=$((total + curr))
done

bspc desktop --focus "$focused_desktop"
